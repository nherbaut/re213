cmake_minimum_required(VERSION 2.8.3)
project(RSI_PA2_SOAP)

SET(GSOAP_INCLUDE_DIR "${CMAKE_SOURCE_DIR}/../contribs/include")
SET(GSOAP_C_LIBRARIES "${CMAKE_SOURCE_DIR}/../contribs/lib/libgsoap.a")
SET(GSOAP_SOAPCPP2 "${CMAKE_SOURCE_DIR}/../contribs/bin/soapcpp2")
#Create the directory that will host files generated by GSOAP
file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/generated) 

#Add application files and gsoap dependencies
SET(SRC_CLIENT_FILES
	main_client.c
	${CMAKE_BINARY_DIR}/generated/soapClientLib.c	
	${CMAKE_BINARY_DIR}/generated/soapC.c
)

SET(SRC_SERVER_FILES
	main_server.c
	${CMAKE_BINARY_DIR}/generated/soapServerLib.c	
	${CMAKE_BINARY_DIR}/generated/soapC.c
)

#some files are generated by gsoap
set_source_files_properties( ${CMAKE_BINARY_DIR}/generated/soapServerLib.c	 PROPERTIES GENERATED TRUE ) 
set_source_files_properties( ${CMAKE_BINARY_DIR}/generated/soapClientLib.c	 PROPERTIES GENERATED TRUE ) 
set_source_files_properties( ${CMAKE_BINARY_DIR}/generated/soapC.c	 PROPERTIES GENERATED TRUE ) 


#include .h folders here
include_directories( 
	${CMAKE_BINARY_DIR}/generated
	${GSOAP_INCLUDE_DIR}
	${CMAKE_SOURCE_DIR}/soap
	${CMAKE_SOURCE_DIR}
)

#add the source files to the client executable
add_executable(GSOAP_CLIENT ${SRC_CLIENT_FILES} )
#add the source files to the client executable
add_executable(GSOAP_SERVER ${SRC_SERVER_FILES} )

#Create a cmake target that generate gsoap files
add_custom_command(
	OUTPUT ${CMAKE_BINARY_DIR}/generated/soapClientLib.c ${CMAKE_BINARY_DIR}/generated/soapC.c
    COMMAND ${GSOAP_SOAPCPP2} -2 -c ${CMAKE_SOURCE_DIR}/soap/api.h -d ${CMAKE_BINARY_DIR}/generated
    COMMENT "CREATING STUBS AND GLUE CODE"
)


   
add_custom_target(GSOAP_GENERATION_TARGET
	DEPENDS ${CMAKE_BINARY_DIR}/generated/soapClientLib.c)
	



#Make sure that the client is compiled only after gsoap has been processed
add_dependencies(GSOAP_CLIENT GSOAP_GENERATION_TARGET)
add_dependencies(GSOAP_SERVER GSOAP_GENERATION_TARGET)


#extra libraries for the executable
target_link_libraries(GSOAP_CLIENT ${GSOAP_C_LIBRARIES} -lpthread)
target_link_libraries(GSOAP_SERVER ${GSOAP_C_LIBRARIES} -lpthread)

#documentation
if(${DOXYGEN_FOUND})

add_custom_target(DOXYGEN_DOCUMENTATION_TARGET
	DEPENDS "${CMAKE_BINARY_DIR}/soap/generated-doc/html/index.html")
	
	
add_custom_command(
        OUTPUT "${CMAKE_BINARY_DIR}/soap/generated-doc/html/index.html"
    COMMAND ${DOXYGEN_EXECUTABLE} ${CMAKE_SOURCE_DIR}/../doc/Doxyfile 
    DEPENDS ${CMAKE_BINARY_DIR}/generated/soapClientLib.c
    COMMENT "GENERATING DOC: ${CMAKE_BINARY_DIR}/soap/generated-doc/html/index.html"
)

add_dependencies(GSOAP_CLIENT DOXYGEN_DOCUMENTATION_TARGET)
add_dependencies(GSOAP_SERVER DOXYGEN_DOCUMENTATION_TARGET)



endif(${DOXYGEN_FOUND})
